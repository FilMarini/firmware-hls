# firmware-hls : HLS implementation of the hybrid L1 track firmware
![HLS build on lnxfarm327](https://github.com/cms-tracklet/firmware-hls/workflows/HLS%20build%20on%20lnxfarm327/badge.svg)

## Repo directory contents:

- TrackletAlgorithm/ : Algo source code.
- project/ : .tcl scripts to create HLS project, compile & run code. 
- TestBenches/ : test bench code
- emData/ : .dat files with input/output test-bench data (corresponding to memory between algo steps) + .tab files of data for LUTs used internally by algos.

An HLS project can be generated by running tcl file with Vivado HLS in firmware-hls/project/ directory. e.g. To do so for the ProjectionRouter:

        vivado_hls -f script_PR.tcl

This would create a project directory \<project> ("projrouter" in case of the above example). The project name is defined in the tcl script. To open the project in GUI:

        vivado_hls -p <project>

## Format of emData/ files.

### .dat files (test bench input/output data)

These have test data corresponding to the contents of the memories between algo steps. Their data format is explained 
in https://twiki.cern.ch/twiki/bin/view/CMS/HybridDataFormat . 

e.g. AllStubs*.dat contains one row per stub: "stub_number stub_coords_(binary)[r|z|phi|...] ditto_but_in_hex"; StubPairs*.dat contains one row per stub pair "pair_number stub_index_in_allstubs_mem_(binary)[innerLayer|outerLayer] ditto_but_in_hex.

File naming convention: "L3" or "D5" indicate barrel or disk number; "PHIC" indicates 3rd course phi division given layer of nonant.

Some of the files are large, so not stored directly in git. These are automatically downloaded when any of the scripts in the project/ directory are executed within Vivado HLS.

### .tab files 

These correspond to LUT used internally by the algo steps.

## Corresponding C++ emulation

The C++ emulation was used to create the files that are downloaded by emData/download.sh. The version used to create these files can be obtained with the following recipe:

```bash
cmsrel CMSSW_11_1_0_pre8
cd CMSSW_11_1_0_pre8/src/
cmsenv 
git cms-checkout-topic -u cms-L1TK:L1TK-dev-11_1_0_pre8
git clone https://github.com/cms-data/L1Trigger-TrackFindingTracklet.git L1Trigger/TrackFindingTracklet/data
cd L1Trigger/TrackFindingTracklet/data/
mkdir -p LUTs \
  MemPrints/CleanTrack \
  MemPrints/FitTrack \
  MemPrints/InputStubs \
  MemPrints/Matches \
  MemPrints/StubPairs \
  MemPrints/Stubs \
  MemPrints/TrackletParameters \
  MemPrints/TrackletProjections \
  MemPrints/VMProjections \
  MemPrints/VMStubsME \
  MemPrints/VMStubsTE
cd -
```

A few changes need to be made in order to enable truncation, to output test vectors and lookup tables, and to disable multiple matches in the MatchCalculator. So open L1Trigger/TrackFindingTracklet/interface/Settings.h and change the parameters to match the following:

```c++
…
    //Offset to the maximum number of steps in each processing step. Set to 0 for standard
    //trunction. Set to large value, e.g. 10000 to remove truncation
    unsigned int maxstepoffset_{0};
…
    bool writeMem_{true};    //If true will print out content of memories to files
    bool writeTable_{true};  //If true will print out content of LUTs to files
…
    // When false, match calculator does not save multiple matches, even when doKF=true.
    // This is a temporary fix for compatibilty with HLS. We will need to implement multiple match
    // printing in emulator eventually, possibly after CMSSW-integration inspired rewrites
    // Use false when generating HLS files, use true when doing full hybrid tracking
    bool doMultipleMatches_{false};
…
```

Then build the release with the usual command:

```bash
scram b -j8
```

Finally, increase the maximum number of events in L1Trigger/TrackFindingTracklet/test/L1TrackNtupleMaker_cfg.py to 100:

```python
…
process.maxEvents = cms.untracked.PSet(input = cms.untracked.int32(100))
…
```

and run the emulation:

```bash
cd L1Trigger/TrackFindingTracklet/test/
cmsRun L1TrackNtupleMaker_cfg.py
```
